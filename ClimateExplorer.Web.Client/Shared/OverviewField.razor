@using Blazorise
@using System.Text.RegularExpressions

<div class="overview-field" title="@(Tooltip == null ? title : Tooltip)" @onclick="ShowPopup">
    <div class="label">@Label</div>
    <div class="value">
        @if (PopupContent != null)
        {
            <a>@Value</a>
        }
        else
        {
            @Value
        }
    </div>
    <div class="additional-info">@AdditionalInfo</div>
</div>

@if (PopupContent != null)
{
    <Modal @ref="popup" Closing="@OnModalClosing">
        <ModalContent Size="ModalSize.Large">
            <ModalHeader>
                <ModalTitle>
                    @(string.IsNullOrWhiteSpace(PopupTitle) ? Label : PopupTitle)
                </ModalTitle>
                <CloseButton />
            </ModalHeader>
            <ModalBody>
                @if (popupContentVisible)
                {
                    @PopupContent
                }
            </ModalBody>
        </ModalContent>
    </Modal>
}

@code {
    string title
    {
        get
        {
            if (!string.IsNullOrWhiteSpace(PopupTitle))
            {
                return PopupTitle!;
            }

            if (PopupContent != null)
            {
                return Label ?? string.Empty;
            }

            return string.Empty;
        }
    }

    [Parameter]
    public string? Label { get; set; }

    [Parameter]
    public string? Tooltip { get; set; }

    [Parameter]
    public string? AdditionalInfo { get; set; }

    [Parameter]
    public RenderFragment? Value { get; set; }

    [Parameter]
    public string? PopupTitle { get; set; }

    [Parameter]
    public RenderFragment? PopupContent { get; set; }

    private Modal? popup;
    private bool popupContentVisible = false;

    private async Task ShowPopup()
    {
        if (popup is null || PopupContent is null)
        {
            return;
        }
         
        // Ensure the popup content is instantiated only when user opens the modal
        popupContentVisible = true;
        StateHasChanged();
        await popup.Show();
    }

    private Task OnModalClosing(ModalClosingEventArgs e)
    {
        popupContentVisible = false;

        return Task.CompletedTask;
    }
}
