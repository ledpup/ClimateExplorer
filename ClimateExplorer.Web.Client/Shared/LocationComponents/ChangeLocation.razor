@using Blazorise
@using Blazorise.Components
@using Blazorise.LoadingIndicator
@using ClimateExplorer.Core.Model;
@using ClimateExplorer.WebApiClient.Services
@using GeoCoordinatePortable

<Modal @ref="modal">
    <ModalContent Size="ModalSize.Large">
        <ModalHeader Background="Background.Light">
            <ModalTitle>Change location</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            @if (SelectedLocation != null)
            {
                <Field>
                    Current location: <Strong>@SelectedLocation.FullTitle</Strong>
                </Field>
            }
            
            <Div Class="mt-3">Click the "near me" button to find the station closest to you (the browser will ask to "know your location").</Div>
            <Div Class="mt-1"><Button Clicked="@UseCurrentLocationClicked" Color="Color.Primary">Near me</Button></Div>

                @if (BrowserLocationErrorMessage != null)
                {
                    <Div class="error-message">
                        @BrowserLocationErrorMessage
                    </Div>
                }
            
            <Div Class="mt-1"><Button Clicked="@RandomLocationClicked" Color="Color.Secondary">Random location</Button></Div>
            
            @if (LocationDictionary is not null)
            {
                <Field Class="mt-3">
                    <FieldLabel>Free text search for a location</FieldLabel>
                    <Autocomplete TItem="Location"
                    TValue="Guid"
                    Data="@LocationDictionary.Values"
                    TextField="@((item) => item.FullTitle)"
                    ValueField="@((item) => item.Id)"
                    Placeholder="Search..."
                    Filter="AutocompleteFilter.Contains"
                    FreeTyping
                    MinLength="2"
                    SelectedValueChanged="@FireOnLocationChange"
                    MaxMenuHeight="350px"
                    @bind-SelectedText="@selectedText" />
                </Field>

                <Field>
                    <FieldLabel>Select a nearby location</FieldLabel>
                    <FieldBody>
                        <LoadingIndicator @bind-visible="@NearbyLocationsLoading">
                            <Table Borderless Narrow Striped>
                                <TableBody>
                                    @if (NearbyLocations is not null)
                                    {
                                        foreach (var row in NearbyLocations)
                                        {
                                            var location = LocationDictionary[row.LocationId];
                                            <TableRow>
                                                <TableRowCell>
                                                    <Blazorise.Link Title="@location.FullTitle"
                                                    To="#"
                                                    Clicked="@(() => FireOnLocationChange(row.LocationId))">
                                                        @location.Name
                                                    </Blazorise.Link>
                                                </TableRowCell>
                                                <TableRowCell>@location.Country</TableRowCell>
                                                <TableRowCell>@(row.Distance) km</TableRowCell>
                                                <TableRowCell>
                                                    <span>
                                                        @row.CompassRoseDirection
                                                    </span>
                                                </TableRowCell>
                                                <TableRowCell>
                                                    <span style="display: inline-block; transform: rotate(@($"{row.BearingDegrees}deg")); transform-origin: center;">↑</span>
                                                </TableRowCell>
                                            </TableRow>
                                        }
                                    }
                                    else
                                    {
                                        for (var i =0; i < 10; i++)
                                        {
                                            <TableRow><TableRowCell>&nbsp;</TableRowCell></TableRow>
                                        }
                                    }
                            </TableBody>
                            </Table>
                        </LoadingIndicator>
                    </FieldBody>
                </Field>
            }
        </ModalBody>
    </ModalContent>
</Modal>

@code {
    Modal? modal;

    [Inject]
    public IDataService? DataService { get; set; }

    [Parameter]
    public Dictionary<Guid, Location>? LocationDictionary { get; set; }

    [Parameter]
    public Location? SelectedLocation { get; set; }

    [Parameter]
    public string? BrowserLocationErrorMessage { get; set; }

    [Parameter]
    public EventCallback<Guid> OnLocationChange { get; set; }

    [Parameter]
    public EventCallback SetCurrentLocation { get; set; }

    string? selectedText;

    Guid? InternalLocationId { get; set; }

    public IEnumerable<LocationDistance>? NearbyLocations { get; set; }

    bool NearbyLocationsLoading { get; set; } = true;

    protected override async Task OnParametersSetAsync()
    {
        if (LocationDictionary is null)
        {
            return;
        }

        if (SelectedLocation is not null && SelectedLocation.Id != InternalLocationId)
        {
            InternalLocationId = SelectedLocation.Id;
            NearbyLocations = null;
            NearbyLocationsLoading = true;
        }
    }

    public async Task Show()
    {
        selectedText = null;

        if (SelectedLocation is not null && NearbyLocations is null)
        {
            _ = LoadNearbyLocationsAsync(SelectedLocation.Id);
        }

        await modal!.Show();
    }

    private async Task LoadNearbyLocationsAsync(Guid locationId)
    {
        NearbyLocations = await DataService!.GetNearbyLocations(locationId);
        NearbyLocationsLoading = false;
        StateHasChanged();
    }

    public Task Hide()
    {
        return modal!.Hide();
    }

    async Task UseCurrentLocationClicked()
    {
        await SetCurrentLocation.InvokeAsync();
        await Hide();
    }

    async Task FireOnLocationChange(Guid locationId)
    {
        if (locationId != Guid.Empty)
        {
            await OnLocationChange.InvokeAsync(locationId);
            await Hide();
        }
    }

    async Task RandomLocationClicked()
    {
        var random = new Random();
        var randomLocation = random.Next(LocationDictionary!.Values.Count());
        await OnLocationChange.InvokeAsync(LocationDictionary!.Values.ToArray()[randomLocation].Id);
        await Hide();
    }
}