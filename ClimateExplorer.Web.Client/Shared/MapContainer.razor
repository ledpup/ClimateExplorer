@using Blazorise
@using ClimateExplorer.Core.Model;
@using CurrentDevice;
@using DPBlazorMapLibrary;

<div class="mapContainer collapsed" id="mapContainer">
    @if (mapOptions != null)
    {
        <DPBlazorMapLibrary.Map @ref="map" MapOptions="@mapOptions" AfterRender="@AfterMapRender"></DPBlazorMapLibrary.Map>
    }

    <div class="@(IsMapExpanded ? "mapToggleExpanded" : "mapToggleCollapsed")">
        <Button Clicked="@ToggleMapExpansion" Class="map-toggle-button" Disabled="Locations is null" Visibility="map is null ? Visibility.Invisible : Visibility.Visible">
            @if (IsMapExpanded)
            {
                <span><i class="fas fa-compress"></i> Collapse</span>
            }
            else
            {
                <span><i class="fas fa-expand"></i> Expand</span>
            }
        </Button>
    </div>
</div>

@code {
    [Parameter] public IEnumerable<Location>? Locations { get; set; }
    [Parameter] public EventCallback<Guid> OnLocationChange { get; set; }
    [Parameter] public Location? Location { get; set; }

    [Inject] public LayerFactory? LayerFactory { get; init; }
    [Inject] IIconFactory? IconFactory { get; init; }
    [Inject] IJSRuntime? JsRuntime { get; init; }
    [Inject] ILogger<MapContainer>? Logger { get; init; }
    [Inject] ICurrentDeviceService? CurrentDeviceService { get; set; }

    Map? map;
    MapOptions? mapOptions;
    bool IsMapExpanded { get; set; } = false;
    bool? IsMobileDevice { get; set; }

    bool mainTileLayerCreated = false;

    int lastExpandedZoom = 8;
    int lastCollapsedZoom = 8;
    LatLng? expandedCentre = null;
    LatLng? collapsedCentre = null;

    Location? InternalLocation;

    List<Guid> MarkersAdded = new();
    List<MarkerOptions> markerOptions = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsMobileDevice == null)
        {
            IsMobileDevice = await CurrentDeviceService!.Mobile();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (IsMobileDevice == null || InternalLocation?.Id == Location?.Id)
        {
            return;
        }

        InternalLocation = Location;

        InitialiseMapOptions();

        await ScrollToPoint(Location!.Coordinates);
        
        if (IsMapExpanded)
        {
            await ToggleMapExpansion();
        }

        await base.OnParametersSetAsync();
    }

    private async Task AfterMapRender()
    {
        await CreateMarkerOptions();
        await CreateMainTileLayer();
        await CreateMapMarkers();
        await map!.OnMoveEnd(async (moveEvent) => await HandleMoveEnd(moveEvent));
    }

    private async Task ScrollToPoint(Coordinates point)
    {
        if (map == null)
        {
            return;
        }

        try
        {
            var latlng = new LatLng(point.Latitude, point.Longitude);
            await map.PanTo(latlng);
        }
        catch (Exception ex)
        {
            Logger!.LogError(ex, "Error with PanTo on map");
            await Task.Delay(500);
            await ScrollToPoint(point);
        }
    }

    public async Task CreateMapMarkers()
    {
        if (Locations == null || mapOptions == null || map == null || this.IconFactory == null || this.LayerFactory == null || JsRuntime == null)
        {
            return;
        }

        Logger!.LogInformation("Creating map markers");

        var bounds = await map.GetBounds();

        int added = 0;
        foreach (var location in Locations)
        {
            if (MarkersAdded.Contains(location.Id))
            {
                continue;
            }

            var lat = location.Coordinates.Latitude;
            var lng = location.Coordinates.Longitude;

            bool latInRange = IsLatBetween(lat, bounds.SouthWest!.Lat, bounds.NorthEast!.Lat);
            bool lngInRange = IsLngBetween(lng, bounds.SouthWest!.Lng, bounds.NorthEast!.Lng);

            if (!latInRange || !lngInRange)
            {
                continue;
            }

            var label = location.HeatingScore == null 
                    ? "null"
                    : location.HeatingScore.Value < 0
                        ? "negative" 
                        : location.HeatingScore.Value.ToString();

            var markerOption = markerOptions.Single(x => x.Alt == label);
            var marker = await this.LayerFactory.CreateMarkerAndAddToMap(new LatLng(lat, lng, location.Coordinates.Elevation ?? 0), map, markerOption);

            await marker.BindTooltip(location.FullTitle!);
            await marker.OnClick(async (MouseEvent mouseEvent) => await HandleMapMouseEvent(mouseEvent));

            MarkersAdded.Add(location.Id);

            added++;
        }

        Logger!.LogInformation($"Created {added} markers.");

        Logger!.LogInformation("Created map markers");
    }

    static bool IsLatBetween(double value, double a, double b)
    {
        var min = Math.Min(a, b);
        var max = Math.Max(a, b);
        return value >= min && value <= max;
    }

    static bool IsLngBetween(double lng, double west, double east)
    {
        // Normal case: west <= east
        if (west <= east)
        {
            return lng >= west && lng <= east;
        }

        // Bounds cross the dateline (e.g. west=170, east=-170)
        return lng >= west || lng <= east;
    }

    async Task CreateMarkerOptions()
    {
        if (markerOptions.Any())
        {
            return;
        }

        markerOptions = new List<MarkerOptions>();
        for (var i = -1; i < 11; i++)
        {
            var label = i == -1 
                                ? "negative"
                                : i == 10 
                                    ? "null" 
                                    : i.ToString();
            var iconOptions = new IconOptions
                {
                    IconUrl = $"/images/map-markers/{ label }.png",
                    IconSize = new Point(48, 48),
                    IconAnchor = new Point(23, 47),
                };

            markerOptions.Add(
                new MarkerOptions
                {
                    Alt = label,
                    Opacity = 0.75,
                    Draggable = false,
                    IconRef = await this.IconFactory!.Create(iconOptions),
                });
        }
    }

    public async Task CreateMainTileLayer()
    {
        if (map == null)
        {
            return;
        }

        if (mainTileLayerCreated)
        {
            return;
        }

        Logger!.LogInformation("Creating main tile layer");

        // Create Tile Layer
        var tileLayerOptions =
            new TileLayerOptions()
                {
                    Attribution = "&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors"
                };

        var mainTileLayer = await LayerFactory!.CreateTileLayerAndAddToMap("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", map!, tileLayerOptions);

        mainTileLayerCreated = true;

        Logger!.LogInformation("Created main tile layer");
    }

    async Task HandleMapMouseEvent(MouseEvent mouseEvent)
    {
        Logger!.LogInformation("HandleMapMouseEvent()");

        var lat = Math.Round(mouseEvent.LatLng!.Lat, 1);
        var lng = Math.Round(mouseEvent.LatLng.Lng, 1);
        var newLocation = Locations!.Single(x => Math.Round(x.Coordinates.Latitude, 1) == lat && Math.Round(x.Coordinates.Longitude, 1) == lng);
        await OnLocationChange.InvokeAsync(newLocation.Id);
    }

    async Task ToggleMapExpansion()
    {
        MarkersAdded = new(); // Force re-creation of markers
        mainTileLayerCreated = false;
        mapOptions = null;

        var zoom = await map!.GetZoom();
        if (IsMapExpanded)
        {
            lastExpandedZoom = zoom;
            expandedCentre = await map!.GetCenter();
        }
        else
        {
            lastCollapsedZoom = zoom;
            collapsedCentre = Location is null ? null : new LatLng(Location.Coordinates.Latitude, Location.Coordinates.Longitude);
        }

        await JsRuntime!.InvokeVoidAsync("toggleMapExpansion", null);
        IsMapExpanded = !IsMapExpanded;

        InitialiseMapOptions();
    }

    void InitialiseMapOptions()
    {
        Logger!.LogInformation("Initialising map options");

        Logger!.LogDebug($"IsMapExpanded = {IsMapExpanded}");

        if (mapOptions == null && Location is not null)
        {
            var centre = new LatLng(Location.Coordinates.Latitude, Location.Coordinates.Longitude);
            mapOptions = new MapOptions()
                {
                    Center = IsMapExpanded ? expandedCentre ?? centre : collapsedCentre ?? centre,
                    Zoom = IsMapExpanded ? lastExpandedZoom : lastCollapsedZoom,
                    Dragging = !(bool)IsMobileDevice! || IsMapExpanded
                };
        }

        Logger!.LogInformation("Map options initialised");
    }

    private async Task HandleMoveEnd(MoveEvent moveEvent)
    {
        await CreateMapMarkers();
    }
}